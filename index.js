const keyboardObj = {
  en: {
    upper: {
      Backquote: '~',
      Digit1: '!',
      Digit2: '@',
      Digit3: '#',
      Digit4: '$',
      Digit5: '%',
      Digit6: '^',
      Digit7: '&',
      Digit8: '*',
      Digit9: '(',
      Digit0: ')',
      Minus: '_',
      Equal: '+',
      Backspace: 'backspace',

      Tab: 'tab',
      KeyQ: 'Q',
      KeyW: 'W',
      KeyE: 'E',
      KeyR: 'R',
      KeyT: 'T',
      KeyY: 'Y',
      KeyU: 'U',
      KeyI: 'I',
      KeyO: 'O',
      KeyP: 'P',
      BracketLeft: '{',
      BracketRight: '}',
      Backslash: '|',

      CapsLock: 'caps lock',
      KeyA: 'A',
      KeyS: 'S',
      KeyD: 'D',
      KeyF: 'F',
      KeyG: 'G',
      KeyH: 'H',
      KeyJ: 'J',
      KeyK: 'K',
      KeyL: 'L',
      Semicolon: ':',
      Quote: '"',
      Enter: 'enter',

      ShiftLeft: 'shift',
      KeyZ: 'Z',
      KeyX: 'X',
      KeyC: 'C',
      KeyV: 'V',
      KeyB: 'B',
      KeyN: 'N',
      KeyM: 'M',
      Comma: '<',
      Period: '>',
      Slash: '?',
      ShiftRight: 'shift',

      ControlLeft: 'ctrl',
      Fn: 'fn',
      Window: 'meta',
      AltLeft: 'alt',
      Space: ' ',
      AltRight: 'alt',
      ControlRight: 'ctrl',
      ArrowLeft: '←',
      ArrowUp: '↑',
      ArrowDown: '↓',
      ArrowRight: '→',
    },
    lower: {
      Backquote: '`',
      Digit1: '1',
      Digit2: '2',
      Digit3: '3',
      Digit4: '4',
      Digit5: '5',
      Digit6: '6',
      Digit7: '7',
      Digit8: '8',
      Digit9: '9',
      Digit0: '0',
      Minus: '-',
      Equal: '=',
      Backspace: 'backspace',

      Tab: 'tab',
      KeyQ: 'q',
      KeyW: 'w',
      KeyE: 'e',
      KeyR: 'r',
      KeyT: 't',
      KeyY: 'y',
      KeyU: 'u',
      KeyI: 'i',
      KeyO: 'o',
      KeyP: 'p',
      BracketLeft: '[',
      BracketRight: ']',
      Backslash: '\\',

      CapsLock: 'caps lock',
      KeyA: 'a',
      KeyS: 's',
      KeyD: 'd',
      KeyF: 'f',
      KeyG: 'g',
      KeyH: 'h',
      KeyJ: 'j',
      KeyK: 'k',
      KeyL: 'l',
      Semicolon: ';',
      Quote: '\'',
      Enter: 'enter',

      ShiftLeft: 'shift',
      KeyZ: 'z',
      KeyX: 'x',
      KeyC: 'c',
      KeyV: 'v',
      KeyB: 'b',
      KeyN: 'n',
      KeyM: 'm',
      Comma: ',',
      Period: '.',
      Slash: '/',
      ShiftRight: 'shift',

      ControlLeft: 'ctrl',
      Fn: 'fn',
      Window: 'meta',
      AltLeft: 'alt',
      Space: ' ',
      AltRight: 'alt',
      ControlRight: 'ctrl',
      ArrowLeft: '←',
      ArrowUp: '↑',
      ArrowDown: '↓',
      ArrowRight: '→',
    },
  },
  ru: {
    upper: {
      Backquote: 'Ё',
      Digit1: '!',
      Digit2: '"',
      Digit3: '№',
      Digit4: ';',
      Digit5: '%',
      Digit6: ':',
      Digit7: '?',
      Digit8: '*',
      Digit9: '(',
      Digit0: ')',
      Minus: '_',
      Equal: '+',
      Backspace: 'backspace',

      Tab: 'tab',
      KeyQ: 'Й',
      KeyW: 'Ц',
      KeyE: 'У',
      KeyR: 'К',
      KeyT: 'Е',
      KeyY: 'Н',
      KeyU: 'Г',
      KeyI: 'Ш',
      KeyO: 'Щ',
      KeyP: 'З',
      BracketLeft: 'Х',
      BracketRight: 'Ъ',
      Backslash: '/',

      CapsLock: 'caps lock',
      KeyA: 'Ф',
      KeyS: 'Ы',
      KeyD: 'В',
      KeyF: 'А',
      KeyG: 'П',
      KeyH: 'Р',
      KeyJ: 'О',
      KeyK: 'Л',
      KeyL: 'Д',
      Semicolon: 'Ж',
      Quote: 'Э',
      Enter: 'enter',

      ShiftLeft: 'shift',
      KeyZ: 'Я',
      KeyX: 'Ч',
      KeyC: 'С',
      KeyV: 'М',
      KeyB: 'И',
      KeyN: 'Т',
      KeyM: 'Ь',
      Comma: 'Б',
      Period: 'Ю',
      Slash: ',',
      ShiftRight: 'shift',

      ControlLeft: 'ctrl',
      Fn: 'fn',
      Window: 'meta',
      AltLeft: 'alt',
      Space: ' ',
      AltRight: 'alt',
      ControlRight: 'ctrl',
      ArrowLeft: '←',
      ArrowUp: '↑',
      ArrowDown: '↓',
      ArrowRight: '→',
    },
    lower: {
      Backquote: 'ё',
      Digit1: '1',
      Digit2: '2',
      Digit3: '3',
      Digit4: '4',
      Digit5: '5',
      Digit6: '6',
      Digit7: '7',
      Digit8: '8',
      Digit9: '9',
      Digit0: '0',
      Minus: '-',
      Equal: '=',
      Backspace: 'backspace',

      Tab: 'tab',
      KeyQ: 'й',
      KeyW: 'ц',
      KeyE: 'у',
      KeyR: 'к',
      KeyT: 'е',
      KeyY: 'н',
      KeyU: 'г',
      KeyI: 'ш',
      KeyO: 'щ',
      KeyP: 'з',
      BracketLeft: 'х',
      BracketRight: 'ъ',
      Backslash: '\\',

      CapsLock: 'caps lock',
      KeyA: 'ф',
      KeyS: 'ы',
      KeyD: 'в',
      KeyF: 'а',
      KeyG: 'п',
      KeyH: 'р',
      KeyJ: 'о',
      KeyK: 'л',
      KeyL: 'д',
      Semicolon: 'ж',
      Quote: 'э',
      Enter: 'enter',

      ShiftLeft: 'shift',
      KeyZ: 'я',
      KeyX: 'ч',
      KeyC: 'с',
      KeyV: 'м',
      KeyB: 'и',
      KeyN: 'т',
      KeyM: 'ь',
      Comma: 'б',
      Period: 'ю',
      Slash: '.',
      ShiftRight: 'shift',

      ControlLeft: 'ctrl',
      Fn: 'fn',
      Window: 'meta',
      AltLeft: 'alt',
      Space: ' ',
      AltRight: 'alt',
      ControlRight: 'ctrl',
      ArrowLeft: '←',
      ArrowUp: '↑',
      ArrowDown: '↓',
      ArrowRight: '→',
    },
  },
};

const row1 = ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace'];
const row2 = ['Tab', 'KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash'];
const row3 = ['CapsLock', 'KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote', 'Enter'];
const row4 = ['ShiftLeft', 'KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash', 'ShiftRight'];
const row5 = ['ControlLeft', 'Fn', 'Window', 'AltLeft', 'Space', 'AltRight', 'ControlRight', 'ArrowLeft', 'ArrowUp', 'ArrowRight'];
const ruKeys = ['Backquote', 'BracketLeft', 'BracketRight', 'Semicolon', 'Quote', 'Comma', 'Period'];
const optKeys = ['Backspace', 'Tab', 'CapsLock', 'Enter', 'ShiftLeft', 'ShiftRight', 'ControlLeft', 'Fn', 'Window', 'AltLeft', 'AltRight', 'ControlRight'];

let language = localStorage.getItem('language') ?? 'en';
let register = 'lower';
let isCapsLock = false;

const body = document.getElementById('body');

const init = () => {
  const main = document.createElement('main');
  main.className = 'main';
  body.appendChild(main);

  const label = document.createElement('label');
  main.appendChild(label);

  const textarea = document.createElement('textarea');
  textarea.className = 'textarea';
  label.appendChild(textarea);

  const keyboard = document.createElement('div');
  keyboard.className = 'keyboard';
  main.appendChild(keyboard);

  for (let i = 0; i < 5; i += 1) {
    const keyboardRow = document.createElement('div');
    keyboardRow.className = 'keyboard__row';
    keyboard.appendChild(keyboardRow);

    const rowInit = (keysArray, currentLanguage) => {
      for (let j = 0; j < keysArray.length; j += 1) {
        const keyId = keysArray[j];
        if (keyId !== 'ArrowUp' && keyId !== 'ArrowDown') {
          const key = document.createElement('div');
          key.className = 'key';
          key.id = keyId;
          keyboardRow.appendChild(key);

          key.innerHTML = keyboardObj[currentLanguage].lower[keyId];
        } else {
          const upDown = document.createElement('div');
          upDown.className = 'up-down';
          keyboardRow.appendChild(upDown);

          const keyUp = document.createElement('div');
          keyUp.className = 'up-down__key';
          keyUp.id = 'ArrowUp';

          keyUp.innerHTML = keyboardObj[currentLanguage].lower.ArrowUp;
          upDown.appendChild(keyUp);

          const keyDown = document.createElement('div');
          keyDown.className = 'up-down__key';
          keyDown.id = 'ArrowDown';

          keyDown.innerHTML = keyboardObj[currentLanguage].lower.ArrowDown;
          upDown.appendChild(keyDown);
        }
      }
    };
    if (i === 0) {
      rowInit(row1, language);
    }
    if (i === 1) {
      rowInit(row2, language);
    }
    if (i === 2) {
      rowInit(row3, language);
    }
    if (i === 3) {
      rowInit(row4, language);
    }
    if (i === 4) {
      rowInit(row5, language);
    }
  }

  const description = document.createElement('div');
  description.className = 'description';
  description.innerHTML = 'Клавиатура создана в операционной системе Linux';
  main.appendChild(description);

  const switchLanguage = document.createElement('div');
  switchLanguage.className = 'switch-language';
  switchLanguage.innerHTML = 'Для переключения языка комбинация: alt + shift';
  main.appendChild(switchLanguage);
};
init();

const redraw = () => {
  const keys = document.querySelectorAll('.key, .up-down__key');
  for (let i = 0; i < keys.length; i += 1) {
    const key = keys[i];

    let keyRegister = register;
    const keyId = key.id.toString();

    if (isCapsLock && (keyId.includes('Key') || (language === 'ru' && (ruKeys.some((k) => k === keyId))))) {
      keyRegister = register === 'upper' ? 'upper' : 'lower';
    } else if (isCapsLock) {
      keyRegister = register === 'upper' ? 'lower' : 'upper';
    }

    key.innerHTML = keyboardObj[language][keyRegister][key.id];
  }
};
redraw();

const switchRegister = (keyId) => {
  if (keyId === 'ShiftRight' || keyId === 'ShiftLeft') {
    register = register === 'upper' ? 'lower' : 'upper';
    redraw();
  }
};

const switchLanguage = (e) => {
  if ((e.code === 'ShiftLeft' && e.altKey)
    || (e.code === 'ShiftRight' && e.altKey)
    || (e.code === 'AltRight' && e.shiftKey)
    || (e.code === 'AltLeft' && e.shiftKey)) {
    language = language === 'ru' ? 'en' : 'ru';
  }
  localStorage.setItem('language', language);
  redraw();
};

const toggleCapsLock = (keyId) => {
  if (keyId === 'CapsLock') {
    const capsLockKey = document.getElementById(keyId);

    register = isCapsLock ? 'lower' : 'upper';

    if (!isCapsLock) {
      capsLockKey.classList.add('active');
      isCapsLock = true;
    } else {
      capsLockKey.classList.remove('active');
      isCapsLock = false;
    }

    redraw();
  }
};

const addSimbl = (simbl = ' ') => {
  const textarea = document.querySelector('.textarea');
  const cursorStart = textarea.selectionStart;
  const cursorEnd = textarea.selectionEnd;

  if (cursorStart === cursorEnd) {
    textarea.value = `${textarea.value.slice(0, cursorStart)}${simbl}${textarea.value.slice(cursorStart)}`;
    textarea.selectionStart = cursorStart + 1;
    textarea.selectionEnd = cursorEnd + 1;
  } else {
    textarea.value = `${textarea.value.slice(0, cursorStart)}${simbl}${textarea.value.slice(cursorEnd)}`;
    textarea.selectionStart = cursorStart + 1;
    textarea.selectionEnd = cursorStart + 1;
  }
};

const removeSimbl = (e) => {
  const textarea = document.querySelector('.textarea');

  const cursorStart = textarea.selectionStart;
  const cursorEnd = textarea.selectionEnd;

  if (cursorStart === 0 && cursorEnd === 0) {
    e.preventDefault();
  } else if (cursorStart === cursorEnd) {
    textarea.value = `${textarea.value.slice(0, cursorStart - 1)}${textarea.value.slice(cursorStart)}`;
    textarea.selectionStart = cursorStart - 1;
    textarea.selectionEnd = cursorStart - 1;
  } else {
    textarea.value = `${textarea.value.slice(0, cursorStart)}${textarea.value.slice(cursorEnd)}`;
    textarea.selectionStart = cursorStart;
    textarea.selectionEnd = cursorStart;
  }
};

const onKeyClick = (keyId, e) => {
  const key = document.getElementById(keyId);

  if (key && !optKeys.includes(keyId)) {
    addSimbl(key.innerHTML);
  }

  if (keyId === 'Backspace') {
    removeSimbl(e);
  }

  if (keyId === 'Enter') {
    addSimbl('\n');
  }

  if (keyId === 'Tab') {
    addSimbl('\t');
  }
};

document.addEventListener('keydown', (e) => {
  const textarea = document.querySelector('.textarea');

  textarea.focus();
  e.preventDefault();

  const keyId = e.code;
  const activeKey = document.getElementById(keyId);

  onKeyClick(keyId, e);

  switchLanguage(e);
  switchRegister(keyId);
  toggleCapsLock(keyId);

  if (keyId === 'CapsLock') {
    return;
  }
  if (activeKey) {
    activeKey.classList.add('active');
  }
});

document.addEventListener('keyup', (e) => {
  const keyId = e.code;
  const activeKey = document.getElementById(keyId);
  switchRegister(keyId);

  if (keyId === 'CapsLock') {
    return;
  }
  if (activeKey) {
    activeKey.classList.remove('active');
  }
});

document.addEventListener('mousedown', (e) => {
  const textarea = document.querySelector('.textarea');

  textarea.focus();
  const keyId = e.target.id;

  if (Object.keys(keyboardObj.en.lower).includes(keyId)
    || e.target.classList.contains('keyboard')
    || e.target.classList.contains('keyboard__row')) {
    e.preventDefault();
  }

  toggleCapsLock(keyId);
  switchRegister(keyId);

  onKeyClick(keyId, e);
});

document.addEventListener('mouseup', (e) => {
  const keyId = e.target.id;

  switchRegister(keyId);
});
